<div class="fixed inset-0 bg-black/50 z-50 backdrop-blur-sm flex justify-center items-center p-4 animate-[fadeIn_0.2s]"
     (click)="onClose()">

    <div class="bg-white rounded-xl shadow-2xl w-full animate-[scaleIn_0.2s] flex flex-col max-h-[90vh]"
         [class.max-w-6xl]="!order"
         [class.max-w-5xl]="order"
         (click)="$event.stopPropagation()">

        <div class="bg-[var(--lumiere-cream)] p-4 border-b border-gray-100 flex justify-between items-center sticky top-0 z-10 rounded-t-xl">
            <h2 class="font-serif-title font-bold text-[var(--lumiere-bordeaux)] text-lg flex items-center gap-2">
                @if (order) {
                    üßæ Encomenda <span class="text-sm font-sans font-normal text-gray-500">#{{ order.id.substring(0,8) }}</span>
                    @if (order.isGift) {
                        <span class="bg-pink-100 text-pink-700 text-[10px] px-2 py-0.5 rounded-full uppercase tracking-wider font-bold border border-pink-200">üéÅ Oferta</span>
                    }
                }
                @else { ‚ú® Nova Venda Manual }
            </h2>
            @if (order) {
                <a [routerLink]="['/admin/print', order.id]"
                   target="_blank"
                   class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded border flex items-center gap-1 transition-colors">
                    üñ®Ô∏è Cart√£o
                </a>
            }
            <button (click)="onClose()" class="text-gray-400 hover:text-black text-xl px-2 transition-colors">‚úï</button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-white relative">

            @if (isLoading) {
            <div class="absolute inset-0 bg-white/80 z-20 flex flex-col justify-center items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--lumiere-bordeaux)] mb-4"></div>
                <p class="text-gray-500 font-medium animate-pulse">A carregar detalhes...</p>
            </div>
            }

            @if (order) {
            <div class="space-y-6 animate-[fadeIn_0.3s]">

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 flex justify-between items-center flex-wrap gap-4">

                    <div class="flex items-center gap-3">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Estado:</span>
                        <div class="relative">
                            <select (change)="onStatusChange($event)"
                                    [value]="order.status"
                                    class="appearance-none pl-4 pr-10 py-2 rounded-full text-xs font-bold border cursor-pointer focus:outline-none focus:ring-2 focus:ring-offset-1 transition-all shadow-sm"
                                    [ngClass]="{
                        'bg-yellow-100 text-yellow-800 border-yellow-200': order.status === 'PENDING',
                        'bg-green-100 text-green-800 border-green-200': order.status === 'PAID',
                        'bg-blue-100 text-blue-800 border-blue-200': order.status === 'SHIPPED',
                        'bg-purple-100 text-purple-800 border-purple-200': order.status === 'DELIVERED',
                        'bg-red-100 text-red-800 border-red-200': order.status === 'CANCELLED',
                        'bg-orange-100 text-orange-800 border-orange-200': order.status === 'RETURNED'
                    }">
                                @for (opt of getAvailableStatusOptions(); track opt.key) {
                                <option [value]="opt.key">{{ opt.label }}</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <span class="text-[10px] font-bold text-gray-400 uppercase">Pagamento:</span>

                        <div class="flex items-center gap-2 font-bold text-sm text-gray-700">
                            @if (order.paymentMethod === 'MBWAY') {
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[#5c0a0a]"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
                                <span>MB WAY</span>
                            }
                            @else if (order.paymentMethod === 'TRANSFER') {
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                                <span>Transfer√™ncia</span>
                            }
                            @else {
                                <span class="text-gray-500">{{ order.paymentMethod }}</span>
                            }
                        </div>
                    </div>

                    <div class="flex items-center gap-3 ml-auto"> @if (order.customerNif) {
                        <button (click)="toggleInvoice()"
                                class="text-xs px-3 py-1 rounded-full font-bold border transition-colors flex items-center gap-2"
                                [class.bg-green-50]="order.invoiceIssued"
                                [class.text-green-700]="order.invoiceIssued"
                                title="Alternar estado da fatura">
                            {{ order.invoiceIssued ? '‚úÖ Fatura Emitida' : '‚è≥ Emitir Fatura' }}
                        </button>
                        }
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm h-full">
                            <h3 class="font-bold text-[var(--lumiere-bordeaux)] border-b pb-3 mb-4 text-xs uppercase tracking-widest flex items-center gap-2">
                                üë§ Comprador / Contacto
                            </h3>
                            <div class="space-y-4">
                                <div>
                                    <span class="text-xs text-gray-400 uppercase">Nome</span>
                                    <p class="font-bold text-gray-800">{{ order.customerName }}</p>
                                </div>
                                <div>
                                    <span class="text-xs text-gray-400 uppercase">Email</span>
                                    <p class="text-sm text-gray-800 break-all">{{ order.customerEmail }}</p>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <span class="text-xs text-gray-400 uppercase">Telefone</span>
                                        <p class="text-sm text-gray-800">{{ order.customerPhone || '--' }}</p>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-400 uppercase">NIF</span>
                                        <p class="text-sm text-gray-800">{{ order.customerNif || 'n/a' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                            <h3 class="font-bold text-[var(--lumiere-bordeaux)] border-b pb-3 mb-4 text-xs uppercase tracking-widest flex items-center gap-2">
                                üöö Log√≠stica & Moradas
                            </h3>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <span class="flex items-center gap-2 text-xs font-bold text-gray-500 uppercase mb-2">
                                        üìç Morada de Envio
                                        <span class="text-[10px] bg-gray-100 px-1 rounded text-gray-400">{{ order.shippingMethod || 'Standard' }}</span>
                                    </span>
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-700">
                                        <p>{{ order.address }}</p>
                                        <p class="font-bold mt-1">{{ order.zipCode }} {{ order.city }}</p>
                                    </div>
                                </div>

                                <div>
                                    <span class="text-xs font-bold text-gray-500 uppercase mb-2 block">üìÑ Morada Fiscal</span>
                                    @if (order.billingAddress && order.billingAddress !== order.address) {
                                    <div class="bg-gray-50 p-3 rounded-lg text-sm text-gray-700 border border-gray-200">
                                        <p>{{ order.billingAddress }}</p>
                                        <p class="font-bold mt-1">{{ order.billingZipCode }} {{ order.billingCity }}</p>
                                    </div>
                                    } @else {
                                    <div class="h-full flex items-center text-gray-400 text-sm italic p-3 border border-dashed rounded-lg">
                                        Igual √† morada de envio.
                                    </div>
                                    }
                                </div>
                            </div>
                        </div>

                        @if (order.isGift) {
                        <div class="bg-pink-50/50 p-5 rounded-xl border border-pink-100 shadow-sm relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-2 opacity-10 text-6xl">üéÅ</div>
                            <h3 class="font-bold text-pink-800 border-b border-pink-100 pb-2 mb-3 text-xs uppercase tracking-widest">
                                Detalhes da Oferta
                            </h3>
                            <div class="flex flex-col md:flex-row gap-6">
                                <div class="text-sm text-pink-900 space-y-1 min-w-[150px]">
                                    <p><span class="opacity-50 text-xs uppercase">De:</span> <strong>{{ order.giftFromName || order.customerName }}</strong></p>
                                    <p><span class="opacity-50 text-xs uppercase">Para:</span> <strong>{{ order.giftToName }}</strong></p>
                                </div>
                                <div class="flex-1 bg-white/60 p-3 rounded-lg border border-pink-100 italic text-gray-600 text-sm font-serif">
                                    "{{ order.giftMessage }}"
                                </div>
                            </div>
                        </div>
                        }
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-gray-700 mb-3 text-sm">Resumo Financeiro</h3>
                    <div class="border rounded-lg overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                            <tr>
                                <th class="p-3"></th>
                                <th class="p-3">Produto</th>
                                <th class="p-3 text-center">Qtd</th>
                                <th class="p-3 text-right">Pre√ßo</th>
                                <th class="p-3 text-right">Total</th>
                            </tr>
                            </thead>
                            <tbody class="divide-y">
                                @for (item of order.items; track $index) {
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-3 font-medium text-gray-700">
                                            <img [src]="'/logo-velas/' + item.sku + '.webp'" [alt]="item.productName" class="w-20 h-20 object-cover">
                                        </td>
                                        <td class="p-3 font-medium text-gray-700">{{ item.productName }}</td>
                                        <td class="p-3 text-center text-gray-600">{{ item.quantity }}</td>
                                        <td class="p-3 text-right text-gray-500">{{ item.price | currency:'EUR' }}</td>
                                        <td class="p-3 text-right font-bold text-gray-800">{{ item.price * item.quantity | currency:'EUR' }}</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="bg-gray-50 border-t-2 border-gray-100 text-sm">
                            <tr>
                                <td colspan="4" class="p-2 text-right text-gray-500">Subtotal Produtos</td>
                                <td class="p-2 text-right text-gray-800">{{ (order.totalAmount - (order.shippingCost || 0) + ((order.discountAmount ?? 0))) | currency:'EUR' }}</td>
                            </tr>
                            <tr>
                                <td colspan="4" class="p-2 text-right text-gray-500">Envio ({{ order.shippingMethod }})</td>
                                <td class="p-2 text-right text-gray-800">
                                    @if (order.shippingCost === 0) {
                                        <span class="text-green-600 font-bold text-xs uppercase bg-green-50 px-2 py-0.5 rounded">
                                            Gr√°tis
                                        </span>
                                    } @else {
                                        {{ order.shippingCost | currency:'EUR' }}
                                    }
                                </td>
                            </tr>
                            @if ((order.discountAmount ?? 0) > 0) {
                                <tr>
                                    <td colspan="4" class="p-2 text-right text-green-600">Desconto ({{ order.appliedPromotionCode }})</td>
                                    <td class="p-2 text-right text-green-600">-{{ order.discountAmount | currency:'EUR' }}</td>
                                </tr>
                            }
                            <tr class="text-base">
                                <td colspan="4" class="p-4 text-right font-bold text-gray-600 uppercase text-xs tracking-wider">Total Final</td>
                                <td class="p-4 text-right font-serif-title font-bold text-xl text-[var(--lumiere-bordeaux)]">
                                    {{ order.totalAmount | currency:'EUR' }}
                                </td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            } @else {
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full animate-[fadeIn_0.3s]" [formGroup]="createForm">
                <div class="space-y-6 overflow-y-auto pr-2 max-h-[70vh] custom-scrollbar">
                    <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm space-y-4">
                        <h3 class="font-bold text-gray-800 border-b pb-2 text-sm uppercase tracking-wider">Dados de Envio</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label-lumiere text-xs font-bold text-gray-500 mb-1 block">Nome (Destinat√°rio) *</label>
                                <input formControlName="customerName" type="text" class="input-lumiere w-full border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="label-lumiere text-xs font-bold text-gray-500 mb-1 block">Telem√≥vel</label>
                                <input formControlName="customerPhone" type="text" class="input-lumiere w-full border-gray-300 rounded-md">
                            </div>
                        </div>
                        <div>
                            <label class="label-lumiere text-xs font-bold text-gray-500 mb-1 block">Email (Para notifica√ß√µes)</label>
                            <input formControlName="customerEmail" type="email" class="input-lumiere w-full border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="label-lumiere text-xs font-bold text-gray-500 mb-1 block">Morada Completa</label>
                            <input formControlName="address" type="text" placeholder="Rua, N¬∫, Andar" class="input-lumiere w-full border-gray-300 rounded-md">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label-lumiere text-xs font-bold text-gray-500 mb-1 block">Cidade</label>
                                <input formControlName="city" type="text" class="input-lumiere w-full border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="label-lumiere text-xs font-bold text-gray-500 mb-1 block">C. Postal</label>
                                <input formControlName="zipCode" type="text" class="input-lumiere w-full border-gray-300 rounded-md">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">

                        <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                            <label class="flex items-center gap-2 cursor-pointer mb-2">
                                <input type="checkbox" formControlName="isGift" class="accent-pink-600 w-4 h-4">
                                <span class="text-sm font-bold text-gray-700">√â para oferecer? (Gift Mode)</span>
                            </label>
                            @if (createForm.get('isGift')?.value) {
                                <div class="pl-6 space-y-3 animate-[fadeIn_0.2s] border-l-2 border-pink-200 mt-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input formControlName="giftFromName" type="text" placeholder="De (Nome)" class="input-lumiere text-xs">
                                        <input formControlName="giftToName" type="text" placeholder="Para (Nome)" class="input-lumiere text-xs">
                                    </div>
                                    <textarea formControlName="giftMessage" rows="2" placeholder="Mensagem da dedicat√≥ria..." class="input-lumiere w-full text-xs"></textarea>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" formControlName="giftHidePrice" class="w-3 h-3">
                                        <span class="text-xs text-gray-500">Esconder pre√ßo</span>
                                    </label>
                                </div>
                            }
                        </div>

                        <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                            <label class="flex items-center gap-2 cursor-pointer mb-2">
                                <input type="checkbox" formControlName="hasDifferentBilling" class="accent-gray-600 w-4 h-4">
                                <span class="text-sm font-bold text-gray-700">Morada de Fatura√ß√£o diferente?</span>
                            </label>
                            @if (createForm.get('hasDifferentBilling')?.value) {
                                <div class="pl-6 space-y-3 animate-[fadeIn_0.2s] border-l-2 border-gray-300 mt-2">
                                    <input formControlName="billingAddress" type="text" placeholder="Morada Fiscal" class="input-lumiere w-full text-xs">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input formControlName="billingCity" type="text" placeholder="Cidade" class="input-lumiere w-full text-xs">
                                        <input formControlName="billingZipCode" type="text" placeholder="CP" class="input-lumiere w-full text-xs">
                                    </div>
                                </div>
                            }
                            <div class="mt-2 pl-6">
                                <input formControlName="customerNif" type="text" placeholder="NIF (Opcional)" class="input-lumiere w-full text-xs border-gray-300">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div>
                            <label class="label-lumiere text-xs font-bold text-gray-500 mb-1 block">Pagamento</label>
                            <select formControlName="paymentMethod" class="input-lumiere text-xs w-full rounded border-gray-300 py-1">
                                <option value="numerario">Numer√°rio</option>
                                <option value="mbway">MBWAY</option>
                                <option value="transferencia">Transfer√™ncia</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-lumiere text-xs font-bold text-gray-500 mb-1 block">M√©todo Envio</label>
                            <select formControlName="shippingMethod" class="input-lumiere text-xs w-full rounded border-gray-300 py-1">
                                <option value="Correio Normal">Normal</option>
                                <option value="Correio Registado">Registado</option>
                                <option value="Em M√£o">Em M√£o</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-lumiere text-xs font-bold text-gray-500 mb-1 block">Custo Envio (‚Ç¨)</label>
                            <input formControlName="shippingCost" type="number" step="0.10" class="input-lumiere w-full text-xs border-gray-300 rounded">
                        </div>
                        <div>
                            <label class="label-lumiere text-xs font-bold text-gray-500 mb-1 block">Canal Venda</label>
                            <select formControlName="channel" class="input-lumiere text-xs w-full rounded border-gray-300 py-1">
                                <option value="DIRECT">Direto (Admin)</option>
                                <option value="MARKET_STALL">Banca</option>
                                <option value="INSTAGRAM">Instagram</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-lumiere text-xs font-bold text-gray-500 mb-1 block">Estado Inicial</label>
                            <select formControlName="status" class="input-lumiere text-xs w-full rounded border-gray-300 py-1">
                                @for (opt of createStatusOptions(); track opt.key) {
                                    <option [value]="opt.key">{{ opt.label }}</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-[var(--lumiere-cream)]/30 p-6 rounded-xl border border-[var(--lumiere-gold)]/20 flex flex-col h-full shadow-inner">
                    <h3 class="font-bold text-gray-800 border-b pb-2 mb-4 text-sm uppercase tracking-wider flex justify-between">
                        üõí Produtos
                        <span class="text-[10px] bg-gray-200 px-2 rounded-full flex items-center">{{ cartItems().length }} itens</span>
                    </h3>

                    <div class="flex gap-2 mb-4" [formGroup]="itemForm">
                        <select formControlName="productId" class="input-lumiere flex-1 text-sm border-gray-300 rounded shadow-sm">
                            <option value="">+ Adicionar produto...</option>
                            @for (p of products(); track p.id) {
                                <option [value]="p.id">{{ p.name }}</option>
                            }
                        </select>
                        <input formControlName="quantity" type="number" class="input-lumiere w-14 text-center border-gray-300 rounded shadow-sm" min="1" value="1">
                        <button (click)="addCartItem()"
                                [disabled]="itemForm.invalid"
                                class="bg-[var(--lumiere-bordeaux)] text-white w-8 rounded font-bold hover:bg-[#3d0210] disabled:opacity-50">
                            +
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto bg-white rounded-lg border border-gray-200 mb-4 p-1 custom-scrollbar shadow-inner">
                        @if (cartItems().length === 0) {
                        <div class="h-full flex flex-col items-center justify-center text-gray-400 space-y-2">
                            <p class="text-sm">Carrinho vazio.</p>
                        </div>
                        }
                        @for (item of cartItems(); track $index) {
                        <div class="flex justify-between items-center p-2 border-b last:border-0 text-xs hover:bg-gray-50">
                            <div>
                                <p class="font-medium text-gray-700">{{ item.productName }}</p>
                                <span class="text-gray-500">x {{ item.quantity }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" [(ngModel)]="item.price" [ngModelOptions]="{standalone: true}" (ngModelChange)="updateCartCalculations()" class="w-14 text-right bg-transparent border-none outline-none font-bold text-[var(--lumiere-bordeaux)]">
                                <button (click)="removeCartItem($index)" class="text-red-400 hover:text-red-600">√ó</button>
                            </div>
                        </div>
                        }
                    </div>

                    <div class="bg-white p-3 rounded-lg border border-gray-200 mb-4 space-y-2 shadow-sm">
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-xs font-bold text-gray-600">üì¶ Sem Caixa</span>
                            <input type="checkbox" formControlName="withoutBox" class="accent-[var(--lumiere-bordeaux)]">
                        </label>
                        <label class="flex items-center justify-between cursor-pointer">
                            <span class="text-xs font-bold text-gray-600">üìÑ Sem Carta</span>
                            <input type="checkbox" formControlName="withoutCard" class="accent-[var(--lumiere-bordeaux)]">
                        </label>
                    </div>

                    <div class="bg-[var(--lumiere-bordeaux)] text-white p-5 rounded-xl flex justify-between items-center shadow-lg">
                        <div class="flex flex-col">
                            <span class="text-xs uppercase opacity-80">Total Estimado</span>
                            <span class="text-[10px] opacity-60">(Inclui envio)</span>
                        </div>
                        <span class="text-2xl font-serif-title font-bold">{{ totalCreateAmount() | currency:'EUR' }}</span>
                    </div>
                </div>
            </div>
            }
        </div>

        <div class="p-4 border-t border-gray-100 flex justify-end gap-3 bg-white rounded-b-xl sticky bottom-0 z-20">
            <button (click)="onClose()" class="px-5 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 font-medium text-sm">
                Fechar
            </button>

            @if (!order) {
            <button (click)="submitCreate()"
                    [disabled]="isLoading || createForm.invalid || cartItems().length === 0"
                    class="btn-primary-lumiere px-6 py-2 rounded-lg shadow-md flex items-center gap-2 disabled:opacity-50 text-sm">
                @if (isLoading) { <div class="animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"></div> }
                {{ isLoading ? 'A gravar...' : 'Criar Venda' }}
            </button>
            }
        </div>

    </div>
</div>
